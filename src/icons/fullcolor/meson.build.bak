categories = run_command(
  'find',
  meson.current_source_dir(),
  '-type', 'f',
  '-name', '*.svg',
  '-printf', '%f\n'
).stdout().strip().split('\n')

#links = run_command(
#  'cat', files('list.txt'),
#).stdout().strip().split('\n')

foreach icon_theme: icon_themes
  # Default-Default, Default-Circle, Default-Square, Green-Default, Green-Circle, Green-Square

  foreach category: categories
    # Apps, Places
    category_folder = category.split('.').get(0)

    source_svg = configure_file(
      input: category,
      output: '@0@.@1@.svg'.format(icon_theme['name'], category_folder),
      command: [
        'sh',
        '-c',
        'sed @4@ "@0@/@1@" > "@OUTPUT@"'.format(
          meson.current_source_dir(),
          category,
          meson.current_build_dir(),
          '@0@.@1@.svg'.format(icon_theme['name'], category_folder),
          icon_theme['hex'],
        )
      ],
    )

    svgs = run_command(
      inkscape, '-S', category,
      '|', 'grep', 'layer', '|', 'awk', '-F,', '{print $1}',
#      'cat', files(category_folder + '.list'),
    ).stdout().strip().split('\n')

#    links = run_command(
#      'cat', files(category_folder + '.link'),
#    ).stdout().strip().split('\n')

 #   sizes = get_option('icon_sizes')
 #   foreach size: sizes
     
 #     install_subdir(
 #       category_folder,
 #       strip_directory: true,
 #       install_dir: join_paths(icon_theme['dir'], size + 'x' + size, category_folder),
 #     )

      foreach svg: svgs
#        standard_dpi = size.to_int() * 2
#        hi_dpi = size.to_int() * 4
  #     google-chrome, terminal-app
        svg_temp_name = '@0@.@1@.@2@'.format(icon_theme['name'], category_folder, svg) 

        base_svg = configure_file(
          input: source_svg,
          output: svg_temp_name + '.svg',
          command: [
            inkscape, '--batch-process',
            '--export-id=@0@'.format(svg),
            '--export-id-only',
            '--export-dpi=96',
#           '--export-margin=1',
            '--export-filename=@OUTPUT@',
            '@INPUT@',
          ]
        )
        install_data(
          base_svg,
          rename: svg + '.png',
          install_dir: join_paths(icon_theme['dir'], category_folder),
        )


#      endforeach
    endforeach
  endforeach
endforeach

#links_full_color_svg = run_command(
#  'cat', files('list.txt'),
#).stdout().strip().split('\n')

#foreach icon: icons
#  foreach svg: files_full_color_svg
#    svg_temp_name = '@0@.@1@'.format(icon['name'], svg)

#    svg_shaped = configure_file(
#      input: svg,
#      output: svg_temp_name,
#      command: [inkscape, '--batch-process', icon['options'], '--export-area-page', '--export-filename=@OUTPUT@', '@INPUT@'],
#    )


#    svg_colored = configure_file(
#      input: svg_shaped,
#      output: svg_temp_name,
#      command: ['sed', '-i', icon['hex'], '@OUTPUT@']
#    )

#    install_data(
#      svg_colored,
#      rename: svg,
#      install_dir: join_paths(icon['dir'], folder),
#    )
#  endforeach

#  foreach link: links_full_color_svg
#    source = link.split(' ').get(0)
#    destination = link.split(' ').get(1)

#    symlink = configure_file(
#      output: destination,
#      command: ['ln', '-fs', source, destination],
#    )
#    install_data(
#      symlink,
#      install_dir: join_paths(icon['dir'], folder),
#    )
#  endforeach

#endforeach
  
